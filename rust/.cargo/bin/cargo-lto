#!/bin/bash
set -e
set -u
set -o pipefail

if [[ $1 == lto ]]; then
    shift
fi

ARGUMENTS=()
while [[ $# -gt 0 ]]; do
    arg=$1
    shift
    if [[ "$arg" == '--' ]]; then
        break
    fi
    ARGUMENTS+=("$arg")
done

export RUSTFLAGS='-C bitcode-in-rlib=yes'
cargo rustc --release "${ARGUMENTS[@]}" -- \
    -C lto \
    -C codegen-units=1 \
    -C panic=abort \
    "$@"
